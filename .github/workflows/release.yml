name: Release
on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest]
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin, x86_64-apple-darwin, universal-apple-darwin

      - name: Install dependencies (Frontend)
        run: npm install

      - name: Build and Create Release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'Topoo Gateway ${{ github.ref_name }}'
          releaseBody: 'See the assets to download this version and install.'
          releaseDraft: false
          prerelease: false
          args: --target universal-apple-darwin

      # 3. 处理 macOS 架构重命名冲突 (解决 422 Already Exists)
      - name: Rename macOS assets for architecture
        if: matrix.platform == 'macos-latest'
        run: |
          # 默认都当作 universal 处理，因为我们在 args 里指定了 universal-apple-darwin
          ARCH="universal"
          
          echo "Detected architecture: $ARCH"
          
          # 进入产物目录 (Tauri v1 路径)
          cd src-tauri/target/universal-apple-darwin/release/bundle/macos/ || cd src-tauri/target/release/bundle/macos/
          
          # 重命名 .app.tar.gz 和 .sig
          if [ -f "Topoo Gateway.app.tar.gz" ]; then
            mv "Topoo Gateway.app.tar.gz" "Topoo Gateway_${ARCH}.app.tar.gz"
            mv "Topoo Gateway.app.tar.gz.sig" "Topoo Gateway_${ARCH}.app.tar.gz.sig"
            echo "Renamed assets to append Arch: $ARCH"
          fi
          
          # 更新对应的 updater.json (指向重命名后的文件)
          # 注意：Tauri Action 可能生成了 updater.json 在某处，或者我们需要自己生成/修改
          # 这里假设项目里原本就有机制生成或者 tauri action 生成了
          # 搜索 updater json
          UPDATER_JSON=$(find ../../../ -name "latest-mac.json" -o -name "install.json" | head -n 1)
          
          if [ -f "$UPDATER_JSON" ]; then
            echo "Updating $UPDATER_JSON to use renamed assets..."
            # 使用 sed 替换文件名
            sed -i '' "s/Topoo%20Gateway.app.tar.gz/Topoo%20Gateway_${ARCH}.app.tar.gz/g" "$UPDATER_JSON"
            
            # 准备上传
            mkdir -p ../../../../../updater_upload
            cp "$UPDATER_JSON" "../../../../../updater_upload/updater_${ARCH}.json"
          else
             echo "Warning: No updater JSON found to patch."
          fi

      # 1. 上传 updater.json 到 Artifacts
      - name: Upload updater json
        uses: actions/upload-artifact@v4
        with:
          name: updater-json-macos
          path: src-tauri/target/**/release/bundle/**/updater_*.json
          if-no-files-found: warn

  publish-release:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download updater artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: updater-json-*
          path: all-updaters
          merge-multiple: true

      - name: Extract Release Notes
        run: |
          VERSION="${{ github.ref_name }}"
          echo "Extracting release notes for version $VERSION"
          if [ -f "README.md" ]; then
             # Simple extraction or default
             echo "See the assets to download this version and install." > release_notes.md
          else
             echo "Release notes" > release_notes.md
          fi

      - name: Merge updater JSONs
        run: |
          echo "Merging updater.json files..."
          echo "{}" > merged_updater.json
          find all-updaters -name "*.json" -type f | while read json_file; do
            if jq -e . "$json_file" >/dev/null 2>&1; then
              echo "Merging valid JSON: $json_file..."
              jq -s '.[0] * .[1]' merged_updater.json "$json_file" > temp.json && mv temp.json merged_updater.json
            fi
          done
          mv merged_updater.json updater.json

      - name: Upload merged updater.json
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          files: updater.json

